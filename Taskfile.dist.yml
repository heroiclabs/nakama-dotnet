version: '3'

vars:
    NAKAMA_REPO_URL: 'https://github.com/heroiclabs/nakama.git'
    SATORI_REPO_URL: 'https://github.com/heroiclabs/satori.git'
    SEMVER: '{{.SEMVER | default "v3.19.0-pre"}}'

tasks:
    build-debug:
        cmds:
            - echo "TODO"

    build-release:
        cmds:
            - echo "TODO"

    generate:
        cmds:
            -   task: generate-nakama
            -   task: generate-nakamaconsole
            -   task: generate-satori
            -   task: generate-satoriconsole
        desc: 'Generate all low-level code for the SDK.'

    generate-nakama:
        cmds:
            - go install tool
            - git clone --depth 1 "{{.NAKAMA_REPO_URL}}" "{{.TMP_DIR}}"
            -   defer: rm -rf "{{.TMP_DIR}}"
            - |
                protoc -I {{.TMP_DIR}} -I {{.TMP_DIR}}/vendor \
                    -I {{.TMP_DIR}}/build/grpc-gateway-v2.3.0/third_party/googleapis \
                    -I {{.TMP_DIR}}/vendor/github.com/grpc-ecosystem/grpc-gateway/v2 \
                    --openapiv2_out={{.TMP_DIR}} --openapiv2_opt=logtostderr=true {{.TMP_DIR}}/apigrpc/apigrpc.proto
            - go run main.go '{{.TMP_DIR}}/apigrpc/apigrpc.swagger.json' 'Nakama' > ../Nakama/ApiClient.gen.cs
        desc: 'Generate low-level ApiClient for Nakama client.'
        dir: 'codegen'
        generates:
            - '../Nakama/ApiClient.gen.cs'
        sources:
            - 'main.go'
        vars:
            TMP_DIR:
                sh: mktemp -d

    generate-nakamaconsole:
        cmds:
            - go install tool
            - git clone --depth 1 "{{.NAKAMA_REPO_URL}}" "{{.TMP_DIR}}"
            -   defer: rm -rf "{{.TMP_DIR}}"
            - |
                protoc -I {{.TMP_DIR}} -I {{.TMP_DIR}}/vendor \
                    -I {{.TMP_DIR}}/vendor/github.com/heroiclabs/nakama-common \
                    -I {{.TMP_DIR}}/build/grpc-gateway-v2.3.0/third_party/googleapis \
                    -I {{.TMP_DIR}}/vendor/github.com/grpc-ecosystem/grpc-gateway/v2 --openapiv2_out={{.TMP_DIR}} \
                    --openapiv2_opt=json_names_for_fields=false,logtostderr=true {{.TMP_DIR}}/console/console.proto
            - go run main.go '{{.TMP_DIR}}/console/console.swagger.json' 'Nakama.Console' > ../Nakama/Console/ConsoleClient.gen.cs
        desc: 'Generate low-level ConsoleClient for Nakama client.'
        dir: 'codegen'
        generates:
            - '../Nakama/Console/ConsoleClient.gen.cs'
        sources:
            - 'main.go'
        vars:
            TMP_DIR:
                sh: mktemp -d

    generate-satori:
        cmds:
            - go install tool
            - git clone --depth 1 "{{.SATORI_REPO_URL}}" "{{.TMP_DIR}}"
            -   defer: rm -rf "{{.TMP_DIR}}"
            - |
                protoc -I {{.TMP_DIR}} -I {{.TMP_DIR}}/vendor \
                    -I {{.TMP_DIR}}/build/grpc-gateway-v2.3.0/third_party/googleapis \
                    -I {{.TMP_DIR}}/vendor/github.com/grpc-ecosystem/grpc-gateway/v2 \
                    --openapiv2_out={{.TMP_DIR}} --openapiv2_opt=logtostderr=true {{.TMP_DIR}}/api/satori.proto
            - go run main.go '{{.TMP_DIR}}/api/satori.swagger.json' 'Satori' > ../Satori/ApiClient.gen.cs
        desc: 'Generate low-level ApiClient for Satori client.'
        dir: 'codegen'
        generates:
            - '../Satori/ApiClient.gen.cs'
        sources:
            - 'main.go'
        vars:
            TMP_DIR:
                sh: mktemp -d

    generate-satoriconsole:
        cmds:
            - go install tool
            - git clone --depth 1 "{{.SATORI_REPO_URL}}" "{{.TMP_DIR}}"
            -   defer: rm -rf "{{.TMP_DIR}}"
            - |
                protoc -I {{.TMP_DIR}} -I {{.TMP_DIR}}/vendor \
                    -I {{.TMP_DIR}}/build/grpc-gateway-v2.3.0/third_party/googleapis \
                    -I {{.TMP_DIR}}/vendor/github.com/grpc-ecosystem/grpc-gateway/v2 \
                    --openapiv2_out={{.TMP_DIR}} --openapiv2_opt=logtostderr=true {{.TMP_DIR}}/console/console.proto
            - go run main.go '{{.TMP_DIR}}/console/console.swagger.json' 'Satori' > ../Satori/Console/ConsoleClient.gen.cs
        desc: 'Generate low-level ConsoleClient for Satori client.'
        dir: 'codegen'
        generates:
            - '../Satori/Console/ConsoleClient.gen.cs'
        sources:
            - 'main.go'
        vars:
            TMP_DIR:
                sh: mktemp -d

    publish-release:
        cmds:
            - echo "TODO"
